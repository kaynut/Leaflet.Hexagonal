/*!
 * Leaflet.Hexagonal.js v1.0
 * 
 * Copyright (c) 2023-present Knut Wanzenberg
 * Released under the MIT License - https://choosealicense.com/licenses/mit/
 * 
 * https://github.com/kaynut/Leaflet.Hexagonal
 * 
 * 
 * 
 * Leaflet plugin (version >=1.0)
 * - draws/clusters points in a hexagonal manner on a canvas-layer
 * - for a well-made overview to hexagons see: https://www.redblobgames.com/grids/hexagons/
 * - as a base for this layer I took Derek Li's CustomLayer
 * 
 * 
 * 
 * 
*/
/*!
 * Leaflet.CustomLayer.js v2.1.0
 * 
 * Copyright (c) 2019-present Derek Li
 * Released under the MIT License - https://choosealicense.com/licenses/mit/
 * 
 * https://github.com/iDerekLi/Leaflet.CustomLayer
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("leaflet")):"function"==typeof define&&define.amd?define(["exports","leaflet"],e):e(((t=t||self).Leaflet=t.Leaflet||{},t.Leaflet.Hexagonal={}),t.L)}(this,(function(t,e){"use strict";var i=(e=e&&e.hasOwnProperty("default")?e.default:e).Layer.extend({options:{container:document.createElement("CANVAS"),zIndex:void 0,opacity:1,minZoom:0,maxZoom:18,hexagonGap:0,hexagonMode:"topFlat",hexagonFill:"#fd1",hexagonLine:"#666",heagonLineWidth:1,highlightMode:!0,highlightFill:"rgba(0,0,0,0.4)",highlightLine:!1,highlightLineWidth:1,infoMode:"adaptOnZoom",infoClassName:"leaflet-hexagonal-marker-container",infoItemsMax:5},initialize:function initialize(t){t.visible=!0,e.setOptions(this,t),e.stamp(this),this._map=void 0,this._container=void 0,this._bounds=void 0,this._center=void 0,this._zoom=void 0},items:[],hexagonals:{},highlightIds:[],beforeAdd:function beforeAdd(){this._zoomVisible=!0},getEvents:function getEvents(){var t={viewreset:this._onLayerViewReset,zoom:this._onLayerZoom,moveend:this._onLayerMoveEnd,zoomend:this._onLayerZoomEnd,click:this._onClick,mousemove:this._onMouseRest};return this._zoomAnimated&&(t.zoomanim=this._onLayerAnimZoom),t},onAdd:function onAdd(){this.fire("layer-beforemount"),this._container||this._initContainer(),this.setOpacity(this.options.opacity),window.isNaN(this.options.zIndex)?this.setZIndex(100):this.setZIndex(this.options.zIndex),this.getPane().appendChild(this._container),this._onZoomVisible(),this.fire("layer-mounted"),this._update()},onRemove:function onRemove(){this.fire("layer-beforedestroy"),this._destroyContainer(),this.fire("layer-destroyed")},_onLayerViewReset:function _onLayerViewReset(){this._reset()},_onLayerAnimZoom:function _onLayerAnimZoom(t){this._updateTransform(t.center,t.zoom)},_onLayerZoom:function _onLayerZoom(){this._updateTransform(this._map.getCenter(),this._map.getZoom())},_onLayerMoveEnd:function _onLayerMoveEnd(){this._isZoomVisible()?this._update():this._zoomHide()},_onLayerZoomEnd:function _onLayerZoomEnd(){this.onZoomEnd()},_onZoomVisible:function _onZoomVisible(){this._isZoomVisible()?this._zoomShow():this._zoomHide()},_initContainer:function _initContainer(){var t=this._container=this.options.container;e.DomUtil.addClass(t,"leaflet-layer"),this._zoomAnimated&&e.DomUtil.addClass(this._container,"leaflet-zoom-animated")},_destroyContainer:function _destroyContainer(){e.DomUtil.remove(this._container),delete this._container},_isZoomVisible:function _isZoomVisible(){var t=this.options.minZoom,e=this.options.maxZoom,i=this._map.getZoom();return i>=t&&i<=e},_zoomShow:function _zoomShow(){this._zoomVisible||(this._zoomVisible=!0,this._map.off({zoomend:this._onZoomVisible},this),this.options.visible&&(this._map.on(this.getEvents(),this),this.getContainer().style.display=""))},_zoomHide:function _zoomHide(){this._zoomVisible&&(this._zoomVisible=!1,this._map.off(this.getEvents(),this),this._map.on({zoomend:this._onZoomVisible},this),this.getContainer().style.display="none")},_updateTransform:function _updateTransform(t,i){var o=this._map.getZoomScale(i,this._zoom),n=e.DomUtil.getPosition(this._container),s=this._map.getSize().multiplyBy(.5),a=this._map.project(this._center,i),r=this._map.project(t,i).subtract(a),h=s.multiplyBy(-o).add(n).add(s).subtract(r);e.Browser.any3d?e.DomUtil.setTransform(this._container,h,o):e.DomUtil.setPosition(this._container,h)},_update:function _update(){if(!this._map._animatingZoom||!this._bounds){this.__update();var t=this._bounds,i=this._container;this._onDraw(),e.DomUtil.setPosition(i,t.min),this.fire("layer-render")}},__update:function __update(){var t=0,i=this._map.getSize(),o=this._map.containerPointToLayerPoint(i.multiplyBy(-0));this._bounds=new e.Bounds(o,o.add(i.multiplyBy(1))),this._center=this._map.getCenter(),this._zoom=this._map.getZoom()},_reset:function _reset(){this._update(),this._updateTransform(this._center,this._zoom)},getContainer:function getContainer(){return this._container},setContainer:function setContainer(t){var e=this.getContainer(),i=e.parentNode;return delete this._container,this.options.container=t,this._container||this._initContainer(),this.setOpacity(this.options.opacity),window.isNaN(this.options.zIndex)?this.setZIndex(100):this.setZIndex(this.options.zIndex),i?i.replaceChild(t,e):this.getPane().appendChild(t),this._update(),this},getOpacity:function getOpacity(){return this.options.opacity},setOpacity:function setOpacity(t){return this.getContainer().style.opacity=this.options.opacity=1*t,this},getZIndex:function getZIndex(){return this.options.zIndex},setZIndex:function setZIndex(t){return this.getContainer().style.zIndex=this.options.zIndex=1*t,this},show:function show(){if(!this.options.visible){if(this.options.visible=!0,this._isZoomVisible())return this._map.on(this.getEvents(),this),this.getContainer().style.display="",this._update(),this;this._zoomHide()}},hide:function hide(){if(this.options.visible)return this.options.visible=!1,this._zoomHide(),this._map.off(this.getEvents(),this),this.getContainer().style.display="none",this},addItem:function addItem(latlng,id,meta){"object"!=typeof latlng&&console.warn("hexagonal.addItem: latlng not valid",latlng),latlng.lat=latlng.lat||0,latlng.lng=latlng.lng||0,"number"!=typeof id&&"string"!=typeof id&&(id="uid_"+Date.now()+"_"+Math.floor(1e5*Math.random()));var item={id:id,latlng:latlng,count:(meta=meta||{}).count||0,secs:meta.secs||0,dist:meta.dist||0,weight:meta.weight||0,ts:meta.ts||0};this.items.push(item)},addItem_tiles15:function addItem_tiles15(tiles15,id,meta){if("string"==typeof tiles15&&(tiles15=JSON.parse(tiles15)),"object"==typeof tiles15){"number"!=typeof id&&"string"!=typeof id&&(id="uid_"+Date.now()+"_"+Math.floor(1e5*Math.random())),meta=meta||{};for(var keys=Object.keys(tiles15),i=0;i<keys.length;i++){var bbox=this.getBbox_from_tile15(keys[i]),latlng,item={id:id,latlng:{lng:(bbox[0]+bbox[2])/2,lat:(bbox[1]+bbox[3])/2},count:meta.count||tiles15[keys[i]].count||0,secs:meta.secs||tiles15[keys[i]].secs||0,dist:meta.dist||tiles15[keys[i]].dist||0,weight:meta.weight||tiles15[keys[i]].weight||0,ts:meta.ts||tiles15[keys[i]].dist||0};this.items.push(item)}}else console.warn("hexagonal.addItem_tiles15: unknown format",tiles15)},addGeojson:function addGeojson(g){if("object"!=typeof g||"string"!=typeof g.type)return 0;if("Point"==g.type&&g.coordinates)return this.addItem({lng:g.coordinates[0],lat:g.coordinates[1]}),1;if("MultiPoint"==g.type||"LineString"==g.type){for(var c=g.coordinates.length,i=0;i<c;i++)this.addItem({lng:g.coordinates[i][0],lat:g.coordinates[i][1]});return c}if("MultiLineString"==g.type){for(var c=0,i=0;i<g.coordinates.length;i++)for(var ci=g.coordinates[i],j=0;j<ci.length;j++)this.addItem({lng:ci[j][0],lat:ci[j][1]}),c++;return c}if("Feature"==g.type)return this.addGeojson(g.geometry);if("FeatureCollection"==g.type)for(var c=0,i=0;i<g.features.length;i++)c+=this.addGeojson(g.features[i].geometry);return console.log("no valid data in geojson"),0},removeItem:function removeItem(id,redraw=!0){if(this.items.length<1)return!1;if("number"!=typeof id&&"string"!=typeof id)return!1;for(var j=0;j<this.items.length;j++)if(id===this.items[j].id)return this.items.splice(j,1),redraw&&this.redraw(),!0;return!1},clearItems:function clearItems(redraw){var c=this.items.length;return this.items=[],redraw&&this.redraw(),c},redraw:function redraw(){this._update()},_preDraw:function _preDraw(){var dpr=L.Browser.retina?2:1,size=this._bounds.getSize();this._container.width=dpr*size.x,this._container.height=dpr*size.y,this._container.style.width=size.x+"px",this._container.style.height=size.y+"px";var zoom=this._map.getZoom(),ctx=this._container.getContext("2d");L.Browser.retina&&ctx.scale(dpr,dpr);var w=dpr*size.x,h=dpr*size.y,hexagonSize=this.calcHexagonSize(zoom),nw=this._map.getBounds().getNorthWest(),hexagonOffset=this._map.project(nw,zoom),hexagonGap=this.options.hexagonGap;this.hexagonals={};for(var i=0;i<this.items.length;i++){var p=this.getPixels_from_latlng(this.items[i].latlng,w,h,hexagonSize);if(p.visible){var h=this.calcHexagon(p.x,p.y,hexagonSize,hexagonOffset,hexagonGap);if(this.hexagonals[h.grid])this.hexagonals[h.grid].items[this.items[i].id]=this.items[i];else{this.hexagonals[h.grid]=h,this.hexagonals[h.grid].items={},this.hexagonals[h.grid].items[this.items[i].id]=this.items[i];var latlng=this._map.containerPointToLatLng([h.cx,h.cy]);this.hexagonals[h.grid].latlng=latlng}}}},_onDraw:function _onDraw(){this._preDraw(),this.onDraw(this._container,this.hexagonals,this.highlightIds)},onDraw:function onDraw(canvas,hexagonals,highlightIds){for(var ctx=canvas.getContext("2d"),hs=Object.keys(hexagonals),h=0;h<hs.length;h++){var hexa=hexagonals[hs[h]];this.drawHexagon(ctx,hexa)}if(highlightIds.length&&this.options.highlightMode)for(var h=0;h<hs.length;h++)for(var hexa=hexagonals[hs[h]],i=0;i<highlightIds.length;i++){var hl=highlightIds[i];if(hexa.items[hl]){this.drawHighlight(ctx,hexa);break}}},drawHexagon:function drawHexagon(ctx,hexagon){var hPath=new Path2D(hexagon.path);this.options.hexagonFill&&(ctx.fillStyle=this.options.hexagonFill,ctx.fill(hPath)),this.options.hexagonLine&&(ctx.strokeStyle=this.options.hexagonLine,ctx.lineWidth=this.options.hexagonLineWidth,ctx.stroke(hPath))},drawHighlight:function drawHighlight(ctx,hexagon){var hPath=new Path2D(hexagon.path);this.options.highlightFill&&(ctx.fillStyle=this.options.highlightFill,ctx.fill(hPath)),this.options.highlightLine&&(ctx.strokeStyle=this.options.highlightLine,ctx.lineWidth=this.options.highlightLineWidth,ctx.stroke(hPath))},_onClick:function _onClick(e){var info=this.updateInfo(e.latlng);this.onClick(e,info)},onClick:function onClick(e,info){return info},_onMouseRest:function _onMouseRest(e){var self=this;window.clearTimeout(self._onMouseRestDebounced_Hexagonal),self._onMouseRestDebounced_Hexagonal=window.setTimeout((function(){var info=self.getInfo_for_latlng(e.latlng);self.onMouseRest(info)}),250)},onMouseRest:function onMouseRest(info){},onZoomEnd:function onZoomEnd(){if(this.info){var zoom=this._map.getZoom();if(zoom<this.options.minZoom||zoom>this.options.maxZoom)return void this.hideInfo();this.showInfo(),"adaptOnZoom"==this.options.infoMode?(this._preDraw(),this.updateInfo(this.info.adapt)):"preserveOnZoom"==this.options.infoMode||(this.info=!1,this.setHighlight(!1),this.setMarker(!1))}},updateInfo:function(latlng){if(!latlng||!this.options.infoMode)return this.info=!1,this.setHighlight(!1),this.setMarker(!1),!1;var info=this.getInfo_for_latlng(latlng);if(!info.items)return this.info=!1,this.setHighlight(!1),this.setMarker(!1),!1;info.adapt=info.items[Object.keys(info.items)[0]].latlng,this.setMarker(info);var itemKeys=Object.keys(info.items);return this.setHighlight(itemKeys),this.info=info,!0},setMarker:function setMarker(info){if(this.marker&&this._map.removeLayer(this.marker),info){var items=this._toArray(info.items),html=this.buildInfo(items),iconHtml=document.createElement("DIV");iconHtml.className="leaflet-hexagonal-marker leftTop",iconHtml.innerHTML=html;var icon=L.divIcon({iconSize:null,html:iconHtml,className:this.options.infoClassName});this.marker=L.marker(info.latlng,{icon:icon}).addTo(this._map),L.DomEvent.on(this.marker,"mousewheel",L.DomEvent.stopPropagation),L.DomEvent.on(this.marker,"click",L.DomEvent.stopPropagation)}},buildInfo:function buildInfo(items){var html="",more="",br="",maxItems=this.options.infoItemsMax;if("function"!=typeof this.itemInfo)return items.length;items.length>maxItems-2&&(more="<br><span style='float:right'>["+(items.length-(maxItems-2))+" more]</span>"),maxItems=Math.min(items.length,maxItems-2);for(var i=0;i<maxItems;i++)html+=br+this.itemInfo(items[i]),br="<br>";return html+more},showInfo:function showInfo(){this.marker&&(document.querySelector(".leaflet-hexagonal-marker-container").style.display="block")},hideInfo:function hideInfo(){this.marker&&(document.querySelector(".leaflet-hexagonal-marker-container").style.display="none")},setHighlight:function setHighlight(ids){this.options.highlightMode&&("string"==typeof ids?this.highlightIds=[ids]:Array.isArray(ids)?this.highlightIds=ids:this.highlightIds=[],this.redraw())},calcHexagonSize:function calcHexagonSize(zoom){var size=8;return zoom>9&&(size=Math.pow(2,zoom-6)),size},calcHexagon:function calcHexagon(x,y,size,offset){if("topPointy"==this.options.hexagonMode)return this.calcHexagon_topPointy(x,y,size,offset);offset=offset||{x:0,y:0};var gap=this.options.hexagonGap,xs=(x+offset.x)/size,ys=(y+offset.y)/size,sqrt3=1.73205081,t=Math.floor(ys+sqrt3*xs+1),idy=Math.floor((Math.floor(2*ys+1)+t)/3),idx=Math.floor((t+Math.floor(sqrt3*xs-ys+1))/3),grid=idx+"_"+idy,cy=(idy-idx/2)*size-offset.y,cx=idx/2*sqrt3*size-offset.x,s0=size-gap,s2=s0/sqrt3,s4=s2/2,h=s0/2,poly,path;return{grid:grid,idx:idx,idy:idy,cx:cx,cy:cy,px:x,py:y,poly:[[cx-s2,cy],[cx-s4,cy-h],[cx+s4,cy-h],[cx+s2,cy],[cx+s4,cy+h],[cx-s4,cy+h],[cx-s2,cy]],path:"M"+(cx-s2)+" "+cy+" L"+(cx-s4)+" "+(cy-h)+" L"+(cx+s4)+" "+(cy-h)+" L"+(cx+s2)+" "+cy+" L"+(cx+s4)+" "+(cy+h)+" L"+(cx-s4)+" "+(cy+h)+"Z"}},calcHexagon_topPointy:function calcHexagon_topPointy(x,y,size,offset){offset=offset||{x:0,y:0};var gap=this.options.hexagonGap,xs=(x+offset.x)/size,ys=(y+offset.y)/size,sqrt3=1.73205081,t=Math.floor(xs+sqrt3*ys+1),idx=Math.floor((Math.floor(2*xs+1)+t)/3),idy=Math.floor((t+Math.floor(sqrt3*ys-xs+1))/3),grid=idx+"_"+idy,cx=(idx-idy/2)*size-offset.x,cy=idy/2*sqrt3*size-offset.y,s0=size-gap,s2=s0/sqrt3,s4=s2/2,h=s0/2,poly,path;return{grid:grid,idx:idx,idy:idy,cx:cx,cy:cy,px:x,py:y,poly:[[cx,cy-s2],[cx-h,cy-s4],[cx-h,cy+s4],[cx,cy+s2],[cx+h,cy+s4],[cx+h,cy-s4],[cx,cy-s2]],path:"M"+cx+" "+(cy-s2)+" L"+(cx-h)+" "+(cy-s4)+" L"+(cx-h)+" "+(cy+s4)+" L"+cx+" "+(cy+s2)+" L"+(cx+h)+" "+(cy+s4)+" L"+(cx+h)+" "+(cy-s4)+"Z"}},getBbox_from_tile15:function getBbox_from_tile15(t15){t15+="AAAAA";for(var z=15,z3=Math.floor(5),q="",ks="ABIJCDKLQRYZSTabEFMNGHOPUVcdWXefghopijqrwx45yz67klstmnuv018923-_",j,k,i=0;i<z3;i++){for(k=(j=ks.indexOf(t15[i])).toString(4);k.length<3;)k="0"+k;q+=k}for(var tx=0,ty=0,b,m,i=0;i<z;i++)m=1<<(b=z-i)-1,"1"===q[z-b]?tx|=m:"2"===q[z-b]?ty|=m:"3"===q[z-b]&&(tx|=m,ty|=m);var f=360/Math.pow(2,z),e=1e-10,x0=(tx+e)*f-180,y0=180-(ty+e)*f,x1=(tx+1+e)*f-180,y1=180-(ty+1+e)*f,r=360/Math.PI;return[x0,r*Math.atan(Math.exp(y1*Math.PI/180))-90,x1,r*Math.atan(Math.exp(y0*Math.PI/180))-90]},getPixels_from_bbox:function getPixels_from_bbox(bbox,w,h){var p0=this._map.latLngToContainerPoint([bbox[1],bbox[0]]),p1=this._map.latLngToContainerPoint([bbox[3],bbox[2]]),visible=!0;return(p1.x<0||p1.y<0||p0.x>w||p0.y>h)&&(visible=!1),{x0:p0.x,y0:p1.y,x1:p1.x,y1:p0.y,visible:visible}},getPixels_from_latlng:function getPixels_from_latlng(latlng,w,h,pad){var p=this._map.latLngToContainerPoint([latlng.lat,latlng.lng]);pad=pad||0;var visible=!0;return(p.x<-pad||p.y<-pad||p.x>w+pad||p.y>h+pad)&&(visible=!1),{x:p.x,y:p.y,visible:!0}},getInfo_for_latlng:function(latlng){var wh=this._map.getSize(),zoom=this._map.getZoom(),size=this.calcHexagonSize(zoom),nw=this._map.getBounds().getNorthWest(),offset=this._map.project(nw,zoom),hexagonGap=this.options.hexagonGap,p=this.getPixels_from_latlng(latlng,wh.w,wh.h,size),h=this.calcHexagon(p.x,p.y,size,offset,hexagonGap);return!!this.hexagonals[h.grid]&&this.hexagonals[h.grid]},getDistance:function(lng1,lat1,lng2,lat2){if("object"==typeof lng1&&"object"==typeof lat1&&(lat2=lat1.lat,lng2=lat1.lng,lat1=lng1.lat,lng1=lng1.lng),lat1==lat2&&lng1==lng2)return 0;var d2r=Math.PI/180,r2d=180/Math.PI,radlat1=lat1*d2r,radlat2=lat2*d2r,theta,radtheta=(lng1-lng2)*d2r,dist=Math.sin(radlat1)*Math.sin(radlat2)+Math.cos(radlat1)*Math.cos(radlat2)*Math.cos(radtheta);return dist>1&&(dist=1),dist=(dist=Math.acos(dist))*r2d*111319.49,Math.round(100*dist)/100},_toArray:function _toArray(obj){var arr=[];if("object"!=typeof obj)return arr;var ks=Object.keys(obj);if(!ks.length)return arr;ks.sort();for(var i=0;i<ks.length;i++)arr.push(obj[ks[i]]);return arr},_toObject:function _toObject(arr,id){var obj={};if(!Array.isArray(arr))return obj;if("string"!=typeof id)return obj;for(var i=0;i<arr.length;i++)arr[i][id]&&(obj[arr[i][id]]=arr[i]);return obj}});function hexagonal(t){return e.hexagonal?new i(t):null}e.Hexagonal=i,e.hexagonal=hexagonal,t.Hexagonal=i,t.hexagonal=hexagonal,t.default=hexagonal,Object.defineProperty(t,"__esModule",{value:!0})}));